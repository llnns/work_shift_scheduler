<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="description" content="Shift Scheduler.">
        <title>Shitf Scheduler</title>
        <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.0/css/bootstrap.min.css" integrity="sha384-PDle/QlgIONtM1aqA2Qemk5gPOE7wFq8+Em+G/hmo5Iq0CCmYZLv3fVRDJ4MMwEA" crossorigin="anonymous">
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.0/js/bootstrap.min.js" integrity="sha384-7aThvCh9TypR7fIc2HV4O/nFMVCBwyIUKL8XCtKE+8xgCgl/PQGuFsvShjr74PBp" crossorigin="anonymous"></script>
        <!--https://github.com/yrezgui/FileSaver.js-->
        <script>
            var saveAs=saveAs||"undefined"!==typeof navigator&&navigator.msSaveOrOpenBlob&&navigator.msSaveOrOpenBlob.bind(navigator)||function(a){"use strict";if("undefined"===typeof navigator||!/MSIE [1-9]\./.test(navigator.userAgent)){var k=a.document,n=k.createElementNS("http://www.w3.org/1999/xhtml","a"),w="download"in n,x=function(c){var e=k.createEvent("MouseEvents");e.initMouseEvent("click",!0,!1,a,0,0,0,0,0,!1,!1,!1,!1,0,null);c.dispatchEvent(e)},q=a.webkitRequestFileSystem,u=a.requestFileSystem||q||a.mozRequestFileSystem,
            y=function(c){(a.setImmediate||a.setTimeout)(function(){throw c;},0)},r=0,s=function(c){var e=function(){"string"===typeof c?(a.URL||a.webkitURL||a).revokeObjectURL(c):c.remove()};a.chrome?e():setTimeout(e,10)},t=function(c,a,d){a=[].concat(a);for(var b=a.length;b--;){var l=c["on"+a[b]];if("function"===typeof l)try{l.call(c,d||c)}catch(f){y(f)}}},m=function(c,e){var d=this,b=c.type,l=!1,f,p,k=function(){t(d,["writestart","progress","write","writeend"])},g=function(){if(l||!f)f=(a.URL||a.webkitURL||
            a).createObjectURL(c);p?p.location.href=f:void 0==a.open(f,"_blank")&&"undefined"!==typeof safari&&(a.location.href=f);d.readyState=d.DONE;k();s(f)},h=function(a){return function(){if(d.readyState!==d.DONE)return a.apply(this,arguments)}},m={create:!0,exclusive:!1},v;d.readyState=d.INIT;e||(e="download");if(w)f=(a.URL||a.webkitURL||a).createObjectURL(c),n.href=f,n.download=e,x(n),d.readyState=d.DONE,k(),s(f);else{a.chrome&&b&&"application/octet-stream"!==b&&(v=c.slice||c.webkitSlice,c=v.call(c,0,
            c.size,"application/octet-stream"),l=!0);q&&"download"!==e&&(e+=".download");if("application/octet-stream"===b||q)p=a;u?(r+=c.size,u(a.TEMPORARY,r,h(function(a){a.root.getDirectory("saved",m,h(function(a){var b=function(){a.getFile(e,m,h(function(a){a.createWriter(h(function(b){b.onwriteend=function(b){p.location.href=a.toURL();d.readyState=d.DONE;t(d,"writeend",b);s(a)};b.onerror=function(){var a=b.error;a.code!==a.ABORT_ERR&&g()};["writestart","progress","write","abort"].forEach(function(a){b["on"+
            a]=d["on"+a]});b.write(c);d.abort=function(){b.abort();d.readyState=d.DONE};d.readyState=d.WRITING}),g)}),g)};a.getFile(e,{create:!1},h(function(a){a.remove();b()}),h(function(a){a.code===a.NOT_FOUND_ERR?b():g()}))}),g)}),g)):g()}},b=m.prototype;b.abort=function(){this.readyState=this.DONE;t(this,"abort")};b.readyState=b.INIT=0;b.WRITING=1;b.DONE=2;b.error=b.onwritestart=b.onprogress=b.onwrite=b.onabort=b.onerror=b.onwriteend=null;return function(a,b){return new m(a,b)}}}("undefined"!==typeof self&&
            self||"undefined"!==typeof window&&window||this.content);"undefined"!==typeof module&&null!==module?module.exports=saveAs:"undefined"!==typeof define&&null!==define&&null!=define.amd&&define([],function(){return saveAs});
        </script>
        <style>
        body{
            background: #20262e;
        }

        .weekdays{
            text-align: center;
        }

        .day{
           min-height: 150px;
           height: 150px;
           position: relative;
           padding-top: .2rem !important;
           text-align: center;

        }

        .month{
           font-size: 1.3rem;
           text-align: center;
        }

        .people{
           font-size: 1rem;
           text-align: center;
        }

        .people_header{
            font-size: 0.8rem;
        }

        .card-header{
            padding: .15rem .15rem;
            text-align: center;
        }
        .card-body {
            padding: 0.25rem;
            line-height: 10px;
        }
        .card-body p{
            padding-left: 0.25rem;
            margin-bottom: 8px;
        }

        .close{
            font-size: 1.3rem;
        }

        .day:hover .add .btn{ display:block; }

        .add .btn{
            padding: .1rem .4rem;
            position: absolute;
            bottom: 10px;
            display:none;
            z-index: 2;
        }

        </style>
        <script>
        var days = [];
        var pid = 1;
        var sid = 1;
        var persons = [];
        var shifts = [];
        var now = new Date();

        const monthNames = ["January", "February", "March", "April", "May", "June",
          "July", "August", "September", "October", "November", "December"
        ];

        function day_cell(id){
          return $("#d" + id);
        }

        class Person {
          constructor(Name) {
            this.id = pid;
            this.name = Name;
            this.score = 0;
            pid+=1;
          }
        }

        class Shift {
            constructor(day_id, sbegin, send, Mul, npeople) {
                var d_b = new Date(now.getFullYear()+"-"+(now.getMonth()+1)+"-"+ day_id +" "+sbegin);
                var d_e = new Date(now.getFullYear()+"-"+(now.getMonth()+1)+"-"+ day_id +" "+send);
                this.id = sid;
                this.extra_day = false;

                if(d_b>d_e){
                    d_e.setDate(d_e.getDate()+1);
                    this.extra_day = true;
                }

                this.begin = d_b;
                this.end = d_e;
                this.day_id = day_id;
                this.sbegin = sbegin;
                this.send = send;
                this.mul = Mul;
                this.npeople = npeople;
                this.value = (d_e - d_b) / 60000 * Mul;
                this.visible = false;
                this.people_assign = [];

                sid += 1;
            }

            update_ui(){
                var mon = this.begin.getMonth();
                var year = this.begin.getYear();

                if(now.getMonth() === mon && now.getYear() === year){
                    if(!this.visible){
                        var extra_d = "";
                        if(this.extra_day){
                            extra_d = "<sup>+1</sup>";
                        }
                        day_cell(this.day_id).append("<div class='card text-white bg-primary mb-2' id='s" + this.id + "' style='max-width: 18rem;'>" +
                                  "<div class='card-header'><svg width='18' height='18'><use xlink:href='#i-user'></use></svg> " +
                                  this.npeople +
                                  "&nbsp;&nbsp;&nbsp;<svg width='18' height='18'><use xlink:href='#i-clock'></use></svg> " +
                                  this.sbegin + "-"+ this.send + extra_d +
                                  " <button type='button' class='close' onclick='delete_shift(" + this.id + ")' aria-label='Close'>" +
                                  "<span aria-hidden='true'>&times;</span></button></div>" +
                                  "<div class='card-body pt-2'>" +
                                  //  "<p class='text-light'>None</p>" +
                                  "</div>" +
                                "</div>");
                        this.visible = true;
                    }

                    $("#s" + this.id).children( ".card-body" ).empty();

                    for (var i = 0; i < this.people_assign.length; ++i) {
                        var p = this.people_assign[i];
                        $("#s" + this.id).children( ".card-body" ).append("<p>" + p.name + "</p>");
                    }
                }else{
                    if(this.visible){
                        $("#s" + this.id).remove();
                        this.visible = false;
                    }
                }
            }

        }

        function Shift_comp(a, b) {
          const av = a.value;
          const bv = b.value;

          let c = 0;
          if (av > bv) {
            c = -1;
          } else if (av < bv) {
            c = 1;
          }
          return c;
        }

        function person_comp(a, b) {
          const av = a.score;
          const bv = b.score;

          let c = 0;
          if (av > bv) {
            c = -1;
        } else if (av < bv) {
            c = 1;
          }
          return c;
        }

        //https://stackoverflow.com/questions/2450954/how-to-randomize-shuffle-a-javascript-array
        function shuffle(array) {
          var currentIndex = array.length, temporaryValue, randomIndex;

          // While there remain elements to shuffle...
          while (0 !== currentIndex) {

            // Pick a remaining element...
            randomIndex = Math.floor(Math.random() * currentIndex);
            currentIndex -= 1;

            // And swap it with the current element.
            temporaryValue = array[currentIndex];
            array[currentIndex] = array[randomIndex];
            array[randomIndex] = temporaryValue;
          }

          return array;
        }

        function commit_sched(event){
            var id = event.data.param1;
            var begin = $( "#tb" ).val();
            var end = $( "#te" ).val();
            var ns = $( "#nscore" ).val();
            var np = $( "#npeo" ).val();
            var new_shift = new Shift(id, begin, end, ns, np);
            shifts.push(new_shift);
            new_shift.update_ui();
            $("#add_sc").modal("hide");
        }

        function delete_shift(id){
            for (i = 0; i < shifts.length; ++i) {
                if(shifts[i].id === id && shifts[i].visible){
                    $("#s" + id).remove();
                    shifts.splice(i, 1);
                    break;
                }
            }
        }

        function add_sched(id){
            $("#commit_sc_add").off();
            $("#commit_sc_add").click({param1: id}, commit_sched);
            $("#add_sc").modal("show");
        }

        function update_people_ui(){
            $("#tpeople tbody").empty();
            persons.sort(person_comp);
            for (i = 0; i < persons.length; ++i) {
                $("#tpeople tbody").append("<tr id='p" + persons[i].id +
                                    "'><th scope='row'>" + (i+1) + "</th><td>" +
                                     persons[i].name + "</td><td>" +
                                     persons[i].score + "<button type='button' class='close' onclick='delete_person(" + persons[i].id + ")' aria-label='Close'>" +
                                     "<span aria-hidden='true'>&times;</span></button></td>");
            }
        }

        function update_shift_ui(){
            for (i = 0; i < shifts.length; ++i) {
                shifts[i].update_ui();
            }
        }

        function clear_all(){
            persons = [];
            update_people_ui();
            for (i = 0; i < shifts.length; ++i) {
                if(shifts[i].visible){
                    $("#s" + shifts[i].id).remove();
                }
            }
            shifts = [];
        }

        function save(){
            var tosave = [persons, shifts];
            var text = JSON.stringify(tosave);
            var blob = new Blob([text], {type: "text/plain;charset=utf-8"});
            saveAs(blob, "scheduler.json");
        }

        function load(){
            $("#load_save").modal("show");
        }

        var fr;
        function load_file(){
            $("#load_save").modal("hide");
            var myFile = $('#fileinput').prop('files')[0];
            fr = new FileReader();
            fr.onload = receivedText;
            fr.readAsText(myFile);
        }

        function receivedText() {
            clear_all();

           var result = JSON.parse(fr.result);
           console.log(result);
           persons = result[0].map (xs => Object.assign(new Person, xs));
           shifts = result[1].map (xs => Object.assign(new Shift, xs));

           for (i = 0; i < shifts.length; ++i) {
               shifts[i].begin = new Date(shifts[i].begin);
               shifts[i].end = new Date(shifts[i].end);
               shifts[i].visible = false;
           }

           sid = shifts.length;
           pid = persons.length;

           update_shift_ui();
           update_people_ui();
         }

        function add_person(){
            var name = $( "#name" ).val();
            var new_person = new Person(name);
            persons.push(new_person);
            update_people_ui();
            $( "#name" ).val("" )
        }

        function delete_person(id){
            for (i = 0; i < persons.length; ++i) {
                if(persons[i].id === id){
                    persons.splice(i, 1);
                    break;
                }
            }
            update_people_ui();
        }

        function process(){

            var s = shifts.sort(Shift_comp);

            for (i = 0; i < persons.length; ++i) {
                persons[i].score = 0;
            }

            shuffle(persons);

            for (i = 0; i < s.length; ++i) {

                s[i].people_assign = [];
                var y = 0;
                var sp = 0;
                while(y < s[i].npeople){
                    var selected_person = persons[sp];

                    if (s[i].people_assign.some(e => e.id === selected_person.id)) {
                        sp+=1;
                        continue;
                    }

                    var p_name = selected_person.name;
                    selected_person.score += s[i].value;

                    s[i].people_assign.push(selected_person);

                    var n = persons.length - 1;
                    while(n > 0 && persons[n].score > selected_person.score){
                        n--;
                    }
                    persons.splice(n+1, 0, selected_person);
                    persons.splice(sp, 1);
                    sp = 0;
                    y++;
                }

                s[i].update_ui();
            }
            update_people_ui();
        }

        function setCalendar(month, year) {
            $("#month_name").empty();
            $("#month_name").append(monthNames[month] + " " + year);
            $("#cale tbody").empty();
            var date = new Date(year, month, 1);
            var start = true;
            while (date.getMonth() === month) {

                // Exclude weekends
                var tmpDate = new Date(date);
                var weekDay = tmpDate.getDay(); // week day
                var day = tmpDate.getDate(); // day

                if(start){
                    $("#cale tbody").append("<tr>");
                    var sDate = new Date(date);
                    start=false;
                    sDate.setDate(date.getDate() - weekDay - 1);
                    for(var i=0; i<weekDay; i++){
                        sDate.setDate(sDate.getDate() + 1);
                        var markup = "<td class='day'><p class='text-muted'>" + sDate.getDate() + "</p></td>";
                        $("#cale tbody").append(markup);
                    }
                }
                date.setDate(date.getDate() + 1);

                var markup = "<td class='day' id='d" + tmpDate.getDate() + "'>" + tmpDate.getDate() +
                             "<div class='d-flex justify-content-center add '><button onclick='add_sched(" +
                             tmpDate.getDate() + ")' type='button' class='btn btn-success'>+</button></div></td>";

                $("#cale tbody").append(markup);
                //days.push(day);

                if(weekDay==6){
                    $("#cale tbody").append("</tr><tr>");
                }

            }

            var tmpDate = new Date(date);
            var weekDay = tmpDate.getDay(); // week day
            var day = tmpDate.getDate(); // day

            for(var i=0; i<7-weekDay; i++){
                tmpDate.setDate(date.getDate() + i);
                var markup = "<td class='day'><p class='text-muted'>" + tmpDate.getDate() + "</p></td>";
                $("#cale tbody").append(markup);
            }

            $("#cale tbody").append("</tr>");

            return days;
        }

        function advance_month(){
            now.setMonth(now.getMonth() + 1);
            setCalendar(now.getMonth(), now.getFullYear());
            update_shift_ui();
        }

        function return_month(){
            now.setMonth(now.getMonth() - 1);
            setCalendar(now.getMonth(), now.getFullYear());
            update_shift_ui();
        }

        $(function() {
            setCalendar(now.getMonth(), now.getFullYear());
        });
        </script>
    </head>
    <body>
        <nav class="navbar navbar-dark bg-dark">
          <span class="navbar-brand mb-0 h1">Scheduler</span>
          <div class="d-flex flex-row-reverse">
              <button type="button" onclick='clear_all()' class="btn btn-info ml-2">Clear</button>
              <button type="button" onclick='save()' class="btn btn-primary ml-2">Save</button>
              <button type="button" onclick='load()' class="btn btn-success ml-2">Load</button>
          </div>
        </nav>
        <div class="container-fluid">
            <div class="row flex-xl-nowrap">
                <div class="col-12 col-md-3 col-xl-2 pt-md-3 bd-sidebar">
                    <table class="table table-light table-striped" id="tpeople">
                      <thead class="thead-dark">
                          <tr>
                              <th scope="col" colspan="3" class="people">People</th>
                          </tr>
                        <tr>
                          <th scope="col" class="people_header">#</th>
                          <th scope="col" class="people_header">Name</th>
                          <th scope="col" class="people_header">Score</th>
                        </tr>
                      </thead>
                      <tbody>
                      </tbody>
                    </table>
                    <div class="card text-white bg-dark">
                        <div class="card-header">Add People</div>
                        <div class="card-body">
                            <form class="form-inline" action="#">
                              <div class="form-group mb-2">
                                <label for="name" class="col-2 col-form-label text-light">Name: </label>
                                <input type="text" class="form-controlt col-5 pl-1 pr-1" id="name">
                                <button type="button" onclick='add_person()' class="btn btn-primary btn-sm ml-3">Add</button>
                              </div>
                            </form>

                            <div class="text-center">
                                <button type="button" class="btn btn-success btn-lg" onclick='process()'>Process</button>
                            </div>
                        </div>
                    </div>
                </div>
                <main class="col col-xl py-md-3 pl-md-5 bd-content" role="main">
                    <table class="table table-bordered table-dark" id="cale">
                      <thead>
                        <tr>
                            <th scope="col" colspan="7" class="month">

                                <div class="d-flex justify-content-between bd-highlight">
                                    <div class="bd-highlight"><button type="button" onclick='return_month()' class="btn btn-secondary"><</button></div>
                                    <div class="bd-highlight" id="month_name">Month 2000</div>
                                    <div class="bd-highlight"><button type="button" onclick='advance_month()' class="btn btn-secondary">></button></div>
                                </div>

                            </th>
                        </tr>
                        <tr class="weekdays">
                          <th scope="col" class="col-1">Sunday</th>
                          <th scope="col" class="col-1">Monday</th>
                          <th scope="col" class="col-1">Tuesday</th>
                          <th scope="col" class="col-1">Wednesday</th>
                          <th scope="col" class="col-1">Thursday</th>
                          <th scope="col" class="col-1">Friday</th>
                          <th scope="col" class="col-1">Saturday</th>
                        </tr>
                      </thead>
                      <tbody>

                      </tbody>
                    </table>
                </main>
            </div>
        </div>
        <div class="modal fade" id="add_sc" tabindex="-1" role="dialog" aria-labelledby="ad" aria-hidden="true">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="ad">Add Shift</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body">
                  <form>
                      <div class="form-group row">
                           <label for="tb" class="col-sm-4 col-form-label">Begin: </label>
                           <input type="time" id="tb" name="appt" value="08:00" required>
                      </div>
                      <div class="form-group row">
                           <label for="te" class="col-sm-4 col-form-label">End: </label>
                           <input type="time" id="te" name="appt" value="13:00" required>
                      </div>
                      <div class="form-group row">
                           <label for="npeo" class="col-sm-4 col-form-label">Number People: </label>
                           <input type="number" class="col-2" id="npeo" value="1" required>
                      </div>
                      <div class="form-group row">
                           <label for="nscore" class="col-sm-4 col-form-label">Weight: </label>
                           <input type="number" class="col-2" id="nscore" value="1" required>
                      </div>
                  </form>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="commit_sc_add">Add</button>
              </div>
            </div>
          </div>
        </div>

        <div class="modal fade" id="load_save" tabindex="-1" role="dialog" aria-labelledby="d" aria-hidden="true">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="d">Load Save</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body">
                  <form>
                      <div class="form-group row">
                           <input type="file" id="fileinput" />
                      </div>
                  </form>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="load_file()" id="load_s_b">Load</button>
              </div>
            </div>
          </div>
        </div>

        <svg id="i-user" viewBox="0 0 32 32" width="18" height="18" fill="none" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2">
            <path d="M22 11 C22 16 19 20 16 20 13 20 10 16 10 11 10 6 12 3 16 3 20 3 22 6 22 11 Z M4 30 L28 30 C28 21 22 20 16 20 10 20 4 21 4 30 Z" />
        </svg>
        <svg id="i-clock" viewBox="0 0 32 32" width="18" height="18" fill="none" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2">
            <circle cx="16" cy="16" r="14" />
            <path d="M16 8 L16 16 20 20" />
        </svg>
    </body>
</html>
